{% extends "base.html" %}

{% block content %}
<header class="header">
    <div class="page-title">Register <span>New User</span></div>
</header>


<div class="content-wrapper">
    <div style="display: flex; flex-wrap: wrap; gap: 2rem; align-items: flex-start;">

        <!-- Left: Form -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3
                style="color:var(--primary-color); margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                User Details
            </h3>

            <div style="margin-bottom: 1.5rem;">
                <label style="display:block; margin-bottom:0.5rem; color:var(--text-muted);">Full Name</label>
                <input type="text" id="username" placeholder="e.g. John Doe">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display:block; margin-bottom:0.5rem; color:var(--text-muted);">Role / Type</label>
                <select id="role"
                    style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;">
                    <option value="Student">üéì Student</option>
                    <option value="Staff">üè¢ Staff / Organization</option>
                </select>
            </div>

            <div style="margin-bottom: 2rem;">
                <label style="display:block; margin-bottom:0.5rem; color:var(--text-muted);">Mobile Number</label>
                <input type="tel" id="phone" placeholder="+1 234 567 8900">
                <small style="color: var(--text-muted);">For SMS Alerts (Optional)</small>
            </div>

            <div id="message" style="margin-bottom: 1rem; font-weight: bold; min-height: 24px;"></div>

            <button id="capture-btn" class="btn btn-primary" style="width: 100%;">CAPTURE & REGISTER</button>
        </div>

        <!-- Right: Camera -->
        <div class="card" style="flex: 1; min-width: 320px;">
            <h3
                style="color:var(--secondary-color); margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                Face Capture
            </h3>
            <p style="color:var(--text-muted); margin-bottom: 1rem;">Position your face clearly within the frame.</p>

            <div class="camera-container"
                style="border-color: var(--secondary-color); position: relative; min-height: 400px; display: flex; align-items: center; justify-content: center; background: #000;">
                <div class="scan-line"
                    style="background: var(--secondary-color); box-shadow: 0 0 10px var(--secondary-color);"></div>
                <video id="video" autoplay playsinline
                    style="width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0;"></video>
                <canvas id="canvas" style="display:none;"></canvas>

                <!-- Face Overlay -->
                <div
                    style="z-index: 10; width: 220px; height: 220px; border: 2px solid rgba(188, 19, 254, 0.5); border-radius: 24px; box-shadow: 0 0 30px rgba(188, 19, 254, 0.2); pointer-events: none; position: relative;">
                    <!-- Corners -->
                    <div
                        style="position: absolute; top: -2px; left: -2px; width: 20px; height: 20px; border-top: 4px solid var(--secondary-color); border-left: 4px solid var(--secondary-color); border-radius: 4px 0 0 0;">
                    </div>
                    <div
                        style="position: absolute; top: -2px; right: -2px; width: 20px; height: 20px; border-top: 4px solid var(--secondary-color); border-right: 4px solid var(--secondary-color); border-radius: 0 4px 0 0;">
                    </div>
                    <div
                        style="position: absolute; bottom: -2px; left: -2px; width: 20px; height: 20px; border-bottom: 4px solid var(--secondary-color); border-left: 4px solid var(--secondary-color); border-radius: 0 0 0 4px;">
                    </div>
                    <div
                        style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; border-bottom: 4px solid var(--secondary-color); border-right: 4px solid var(--secondary-color); border-radius: 0 0 4px 0;">
                    </div>
                </div>
            </div>
            <div style="text-align:center; margin-top:1rem; color:var(--text-muted); font-size:0.8rem;">
                Ensure good lighting for best results.
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const messageDiv = document.getElementById('message');
    const usernameInput = document.getElementById('username');
    const phoneInput = document.getElementById('phone');
    const roleInput = document.getElementById('role');

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { video.srcObject = stream; })
        .catch(err => { showMessage("Camera Blocked.", false); });

    captureBtn.addEventListener('click', () => {
        const name = usernameInput.value.trim();
        const phone = phoneInput.value.trim();
        const role = roleInput.value;

        if (!name || !phone) {
            showMessage("Please fill all details.", false);
            return;
        }

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const imageData = canvas.toDataURL('image/jpeg');

        captureBtn.innerText = "PROCESSING...";
        captureBtn.disabled = true;

        fetch('/api/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, phone: phone, role: role, image: imageData })
        })
            .then(response => response.json())
            .then(data => {
                captureBtn.innerText = "CAPTURE & REGISTER";
                captureBtn.disabled = false;
                showMessage(data.message, data.success);
                if (data.success) {
                    usernameInput.value = "";
                    phoneInput.value = "";
                }
            })
            .catch(err => {
                captureBtn.innerText = "CAPTURE & REGISTER";
                captureBtn.disabled = false;
                showMessage("Error: " + err, false);
            });
    });

    function showMessage(msg, isSuccess) {
        messageDiv.innerText = msg;
        messageDiv.style.color = isSuccess ? 'var(--success)' : 'var(--error)';
        messageDiv.style.textShadow = isSuccess ? '0 0 10px rgba(0,255,157,0.3)' : '0 0 10px rgba(255,0,85,0.3)';
    }
</script>
{% endblock %}